import React, { Suspense, useRef } from 'react';
import { Canvas, useFrame } from '@react-three/fiber';
import { Stage, useGLTF, PerspectiveCamera, Environment, Float } from '@react-three/drei';
import { motion, useScroll, useTransform } from 'framer-motion';

// --- MODÈLE 3D ---
function Car({ scrollYProgress }) {
  const group = useRef();
  // Modèle d'exemple (Porsche 911). Vous pouvez remplacer par votre propre fichier .glb
  const { scene } = useGLTF('https://vazxmixjsiawhamofees.supabase.co/storage/v1/object/public/models/porsche-911-930-turbo/model.gltf');

  useFrame(() => {
    // La voiture tourne sur son axe Y en fonction du défilement
    const rotation = scrollYProgress.get() * Math.PI * 2;
    group.current.rotation.y = rotation;
  });

  return (
    <Float speed={1.5} rotationIntensity={0.2} floatIntensity={0.5}>
      <primitive ref={group} object={scene} scale={1.2} position={[0, -0.5, 0]} />
    </Float>
  );
}

// --- COMPOSANT PRINCIPAL ---
export default function CarShowcase() {
  const containerRef = useRef(null);
  
  // Gestion du scroll
  const { scrollYProgress } = useScroll({
    target: containerRef,
    offset: ["start start", "end end"]
  });

  // Transformations pour les textes
  const heroOpacity = useTransform(scrollYProgress, [0, 0.2], [1, 0]);
  const heroScale = useTransform(scrollYProgress, [0, 0.2], [1, 0.8]);
  const detailsOpacity = useTransform(scrollYProgress, [0.3, 0.5, 0.7], [0, 1, 0]);

  return (
    <div ref={containerRef} style={styles.mainContainer}>
      
      {/* Styles injectés pour l'exemple en un seul fichier */}
      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Inter:wght@300;400;700&display=swap');
        body { margin: 0; background-color: #050505; color: white; font-family: 'Inter', sans-serif; overflow-x: hidden; }
      `}</style>

      {/* Scène 3D Fixe en arrière-plan */}
      <div style={styles.canvasWrapper}>
        <Canvas dpr={[1, 2]} shadows>
          <PerspectiveCamera makeDefault position={[0, 0, 5]} fov={45} />
          <Suspense fallback={null}>
            <Stage environment="city" intensity={0.5} contactShadow={{ opacity: 0.4, blur: 2 }}>
              <Car scrollYProgress={scrollYProgress} />
            </Stage>
          </Suspense>
          <Environment preset="night" />
        </Canvas>
      </div>

      {/* CONTENU TEXTUEL (Scrollable) */}
      
      {/* Section 1 : Hero */}
      <section style={styles.section}>
        <motion.div style={{ ...styles.content, opacity: heroOpacity, scale: heroScale }}>
          <h1 style={styles.title}>EXCELLENCE <br/> <span style={styles.goldText}>MOTRICE</span></h1>
          <p style={styles.description}>Redéfinir la performance à travers le design italien pur.</p>
          <button style={styles.button}>EXPLORER LE MODÈLE</button>
        </motion.div>
      </section>

      {/* Section 2 : Détails techniques */}
      <section style={{ ...styles.section, justifyContent: 'flex-end' }}>
        <motion.div style={{ ...styles.content, opacity: detailsOpacity }}>
          <h2 style={styles.subTitle}>AÉRODYNAMISME</h2>
          <p style={styles.description}>Un coefficient de traînée réduit pour une stabilité absolue à 300 km/h.</p>
          <div style={styles.line}></div>
        </motion.div>
      </section>

      {/* Section 3 : Footer / Action */}
      <section style={styles.section}>
        <motion.div style={styles.content}>
          <h2 style={styles.subTitle}>VOTRE VOYAGE COMMENCE</h2>
          <p style={styles.description}>Configurez votre exemplaire unique dès aujourd'hui.</p>
          <button style={styles.buttonLight}>RESERVER UN ESSAI</button>
        </motion.div>
      </section>

    </div>
  );
}

// --- STYLES (OBJET JS) ---
const styles = {
  mainContainer: {
    position: 'relative',
    backgroundColor: '#050505',
  },
  canvasWrapper: {
    position: 'fixed',
    top: 0,
    left: 0,
    width: '100vw',
    height: '100vh',
    zIndex: 1,
    pointerEvents: 'none',
  },
  section: {
    height: '100vh',
    display: 'flex',
    alignItems: 'center',
    padding: '0 10%',
    position: 'relative',
    zIndex: 2,
  },
  content: {
    maxWidth: '500px',
  },
  title: {
    fontSize: '4.5rem',
    fontWeight: '700',
    fontFamily: "'Playfair Display', serif",
    lineHeight: 1.1,
    margin: 0,
  },
  subTitle: {
    fontSize: '2.5rem',
    color: '#d4af37',
    fontFamily: "'Playfair Display', serif",
  },
  goldText: {
    color: '#d4af37',
  },
  description: {
    fontSize: '1.1rem',
    lineHeight: '1.6',
    color: '#aaaaaa',
    margin: '20px 0',
  },
  button: {
    backgroundColor: '#d4af37',
    color: 'black',
    border: 'none',
    padding: '15px 35px',
    fontWeight: 'bold',
    letterSpacing: '1px',
    cursor: 'pointer',
    marginTop: '20px',
  },
  buttonLight: {
    backgroundColor: 'transparent',
    color: 'white',
    border: '1px solid white',
    padding: '15px 35px',
    fontWeight: 'bold',
    cursor: 'pointer',
  },
  line: {
    width: '60px',
    height: '2px',
    backgroundColor: '#d4af37',
    marginTop: '10px',
  }
};
